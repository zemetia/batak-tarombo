// ============================================================================
// BATAK LINEAGE DATABASE SCHEMA
// ============================================================================
// Normalized Bilateral Version (Marriage Hub)
// ============================================================================

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  GENERAL
  CONTRIBUTOR
  ADMIN
}

enum AuthProvider {
  GOOGLE
  FACEBOOK
  EMAIL
  PHONE
}

enum RequestStatus {
  PENDING
  IN_REVIEW
  APPROVED
  REJECTED
  CANCELLED
}

enum OperationType {
  NEW
  EDIT
  DELETE
}

enum Gender {
  MALE
  FEMALE
}

enum PersonStatus {
  DRAFT
  ACTIVE
  DELETED
}

// ============================================================================
// USER MANAGEMENT (NORMALIZED)
// ============================================================================

model User {
  id       String @id @default(uuid())
  email    String @unique
  
  // Auth
  uid         String?       @unique // Firebase UID
  provider    AuthProvider? 
  password    String?       // Fallback
  
  // Access
  role       UserRole @default(GENERAL)
  isVerified Boolean  @default(false)
  isBanned   Boolean  @default(false)
  
  // One-to-One Profile
  profile    UserProfile?

  // Relations
  requestsSubmitted Request[] @relation("RequestSubmitter")
  requestsReviewed  Request[] @relation("RequestReviewer")
  
  // Audit Relations
  personsCreated    Person[]  @relation("PersonCreator")
  personsUpdated    Person[]  @relation("PersonUpdater")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([email])
  @@index([uid])
}

model UserProfile {
  id        String  @id @default(uuid())
  
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String  @unique

  fullName  String
  marga     String?
  birthday  DateTime?
  whatsapp  String?
  address   String?
  city      String?
  country   String?
  facebook  String?
  instagram String?
  photoURL  String?
}

// ============================================================================
// FAMILY TREE (NORMALIZED BILATERAL HUB)
// ============================================================================

model Person {
  id     String       @id @default(uuid())
  
  // Core Identity
  name   String
  gender Gender
  status PersonStatus @default(DRAFT)
  generation Int?
  deletedAt DateTime? 

  // Lineage: "I am a child of this Marriage"
  parentId String?
  parent   Marriage? @relation("Parenting", fields: [parentId], references: [id])
  
  // Marriage: "I am a partner in these marriages"
  marriagesAsHusband Marriage[] @relation("Husband")
  marriagesAsWife    Marriage[] @relation("Wife")
  
  // Details (Vertical Partitioning)
  detail   PersonDetail?

  // Audit
  createdBy       User?   @relation("PersonCreator", fields: [createdById], references: [id], onDelete: SetNull)
  createdById     String?
  
  lastUpdatedBy   User?   @relation("PersonUpdater", fields: [lastUpdatedById], references: [id], onDelete: SetNull)
  lastUpdatedById String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Request Links
  personRequests PersonRequest[] 

  @@index([name])
  @@index([parentId])
  @@index([status])
}

model PersonDetail {
  id        String @id @default(uuid())
  
  person    Person @relation(fields: [personId], references: [id], onDelete: Cascade)
  personId  String @unique
  
  // Content
  alternativeNames String[]
  birthYear Int?
  deathYear Int?
  isAlive   Boolean @default(true)
  huta      String?
  description String? @db.Text
  
  // Order in family (optional, logic might be complex with Marriage hub)
  birthOrder Int     @default(0)
}

model Marriage {
  id        String   @id @default(uuid())

  // In case ini bingung anak nya dari mama yang mana, tolong buat Marriage dengan id istri null

  // Partners
  husband   Person   @relation("Husband", fields: [husbandId], references: [id], onDelete: Cascade)
  husbandId String
  
  wife      Person?   @relation("Wife", fields: [wifeId], references: [id], onDelete: SetNull)
  wifeId    String? 
  
  // Offspring
  children  Person[] @relation("Parenting")
  
  // Metadata
  marriageDate DateTime?
  note         String?

  @@index([husbandId])
  @@index([wifeId])
}

// ============================================================================
// REQUEST SYSTEM (VERSION CONTROL)
// ============================================================================

model Request {
  id          String @id @default(uuid())
  title       String
  description String? @db.Text
  
  submittedBy   User     @relation("RequestSubmitter", fields: [submittedById], references: [id], onDelete: Cascade)
  submittedById String
  submittedAt   DateTime @default(now())
  
  taromboProveUrl String?

  status      RequestStatus @default(PENDING)
  
  reviewedBy    User?     @relation("RequestReviewer", fields: [reviewedById], references: [id], onDelete: SetNull)
  reviewedById  String?
  reviewedAt    DateTime? 
  adminNotes    String?   @db.Text

  personRequests PersonRequest[]

  updatedAt DateTime @updatedAt
  
  @@index([status])
  @@index([submittedById])
}

model PersonRequest {
  id        String @id @default(uuid())
  
  request   Request @relation(fields: [requestId], references: [id], onDelete: Cascade)
  requestId String

  operation OperationType // NEW, EDIT, DELETE
  
  // Linked Person (The 'Draft' or 'Target')
  person   Person? @relation(fields: [personId], references: [id], onDelete: Cascade)
  personId String?

  // Stored Deltas (JSON)
  // Logic: 
  // - NEW: Points to a Person(status=DRAFT). 'newData' can just be "See linked Person" or copy.
  // - EDIT: Points to Person(status=ACTIVE). 'newData' has proposed changes.
  newData      Json?
  previousData Json?
  
  changedFields String[] @default([])

  createdAt DateTime @default(now())

  @@index([requestId])
  @@index([operation])
}
